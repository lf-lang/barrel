name: C++ tests

on:
  workflow_call:
    inputs:
      compiler-ref:
        required: false
        type: string
      runtime-ref:
        required: false
        type: string
jobs:
  run:
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Install Dependencies OS X
        run: |
          brew install coreutils
          brew install cargo 
        if: runner.os == 'macOS'
      - name: Install clang-tidy, lcov, cargo on Ubuntu
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy
          sudo apt-get install -y lcov
          sudo apt-get install -y cargo
          sudo apt-get install -y wget
        if: matrix.platform == 'ubuntu-latest'
      - name: Build Lingo
        run: cargo build --release
 
      - name: Clone lingua-franca
        run: |
          git clone https://github.com/lf-lang/lingua-franca.git ./lingua-franca
        if: matrix.platform == 'ubuntu-latest'     

      - name: Build Tests
        run: |
          wget https://github.com/lf-lang/lingua-franca/releases/download/v0.4.0/lf-cli-0.4.0.tar.gz -O lf-cli.tar.gz
          tar -xf lf-cli.tar.gz
          ls
        if: matrix.platform == 'ubuntu-latest'
      - name: Build Lingo
        run: |
          cargo b --release
        if: matrix.platform == 'ubuntu-latest'
      - name: Build Tests
        run: |
          ls -alh
          cp tests/Lingo.toml lingua-franca/test/Cpp/
          cd lingua-franca/test/Cpp 
          ls ../../../lf-cli-0.4.0/bin/
          ../../../target/release/lingo build --lfc ../../../lf-cli-0.4.0/bin/lfc
        if: matrix.platform == 'ubuntu-latest'
